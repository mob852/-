# FOC in PMSM

## 	产生三相电路控制电机

### 			单相闭环全桥逆变

1.驱动电路

​	逆变的基本电路

1.1 半桥逆变

​	![img](https://pic1.zhimg.com/v2-967341d88f03513e0b207f8d415aa6ec_r.jpg)

1) 当开关 T1 闭合 T2 断开时，电流方向如图中步骤 1 所示；

2) 当开关 T2 闭合 T1 断开时，开关 T2 不能立即闭合，且在这一瞬间电感电流的方向不能突变，此时电流流过 T2 反并联的二极管续流；

3) 电感电流过零后开关 T2 闭合，电感电流反向流过开关 T2 ；

4) 当开关 T2 断开 T1 再次闭合时，同理开关 T1 不能立即闭合，同前述分析电感电流的方向不能突变，电流流过 T1 反并联的二极管续流，之后的周期重复上述过程。

步骤 2 和 步骤 4 是能量反馈过程，二极管在其中提供反馈能量通道，同时此过程也是负载电流的续流过程。因此，逆变电路中的二极管可以称为反馈二极管或续流二极管。

1.2 全桥逆变

![img](https://pic1.zhimg.com/80/v2-4d8dcd554fb6c520b68c860955a50e90_720w.webp)

可以看到，通过控制mos管的开关便可生成正负的方波。

但是如何通过将其变为正弦波，可以借用微积分的思想。在t1到t2时间内将其分为更小的时间段如a，如果想要更大的电压就在a这个时间段将mos管q1，q4导通的时间更长一些，更小的电压就导通的更短一些。

效果如下图，上方的是输出的电压，下方就是控制mos管的时间。

![img](https://img-blog.csdnimg.cn/8cf2e7e1761049c6a6a43706e9c7040b.png)

那么接下来的问题就是如何控制这4个mos管。

首先，根据微积分的思想，将想要产生的波形成为基波，用于截取电压的称为载波，载波可以理解为脉冲信号，可是现实中并没有理想的脉冲信号，一般是采用等腰三角波。最后生成的波形跟基波有较大联系，基本就是基波plus。

![img](https://img-blog.csdnimg.cn/cca73bca10184789ae78cc53f31e471e.png)

当正弦波大于三角波的时候就是mos管导通的时间，三角波可以理解为采样信号。

![img](https://img-blog.csdnimg.cn/0f4af674bbe24f70a29378a69654d4ec.png)

![img](https://img-blog.csdnimg.cn/05a9f08e9f2f4c4b84d5172d98378079.png)

##### 定时器设置

单片机虽然产生不了正弦波，但是可以比较轻易的通过控制gpio的正负产生方波，用4路pwm输出就可以控制q1 q2 q3 q4，这样就能产生正弦波了。那么该如何产生这4种pwm波呢，首先，单片机是通过定时器来产生pwm，有基本定时器，通用定时器，高级定时器。有几种功能，输出比较，输入捕获，产生pwm使用的是输出比较，定时器通过时基产生一个个脉冲，每个脉冲到来的时候count+1，定时器的寄存器有两位，arr与crr，将arr理解为pwm的周期，crr理解为高位输出，count小于crr将链接的gpio输出高位，高与crr小于arr的输出低位，但是arr的值小于crr会发生啥呢，count在到达arr会产生定时器中断，如果不设置的话，应该是会一直产生高电位输出。

既然定时器在到达每个计数周期都会产生定时器中断，那么在中断中就可以设置arr与crr的值，下一个pwm的输出的脉冲宽度就可以不同，最好还是固定一个arr的值作为基本的周期，调节crr的值，每次输出的脉宽不同就可以实现上图效果。那么每个周期该设置的crr值是多少呢。

首先确定定时器的时基，假设为48m，经过预分频，48/(5+1)产生8mhz的定时器用来计数的基频，假设每个pwm的周期计数为100，即arr为100，产生的便是10khz的定时器基频，周期点数 ：10Khz（定时器基频） / 50 Hz（想产生的正弦波频率） = 200 ，每个正弦波由200个调制PWM波形组成，正弦波由200个调制pwm波组成，每个pwm波的周期就是arr。之前曾经说过基波就是想要产生的正弦波，通过 SPWM表格选择基波的中值、幅值，点数，在每个定时器中断中更新crr的值就能产生想要的波形了。

不过需要生成的正弦波是有负值的，正弦表中的负值赋值给crr显然是不对的，那么该如何处理呢。首先我们可以观察上图发现负值就是在正弦波的负半轴赋值给q1的，正弦都是对称的，将正弦表的负值取反变正赋值给q2就行了。

![img](https://img-blog.csdnimg.cn/05a9f08e9f2f4c4b84d5172d98378079.png)

一般情况下，功率管驱动芯片上管和下管是互补导通的，因此导通时序也可如下图：

![img](https://img-blog.csdnimg.cn/af8f9c18e230423298936a1382e7c02b.png)

这样子只需要q1的crr值在负半轴就是arr-正弦表的值。

q2使用定时器的互补通道输出即可，而q3 q4只需要在定时器中断中判断采样点数来判断半个周期，前半个周期q3为1，q4为0，后半个周期q3为0，q4为1。

需要注意的是由于q1 q2互补，而不可能让q1 q2 同时导通导致短路，所以产生的pwm需要设置死区。

以上介绍的是单极性，双极性导通的mos管控制如下：

![img](https://img-blog.csdnimg.cn/1ed094a8dff842d2bf2ab9ca598503ec.png)

q1 q3相同，q2 q4 相同，q1 q2互补。

用两个定时器同时产生一样的pwm，两个互补pwm便可实现。



单极性实现：

平台：apm32f030c8t6 /stm32f030c8t6

![image-20240416191616217](C:\Users\syd12\AppData\Roaming\Typora\typora-user-images\image-20240416191616217.png)

配置定时器TIM16产生互补pwm 再通过驱动芯片来控制q1 q2。 

计数基频：48/（psc+1）=8mhz

定时器基频：8mhz/800=10khz

正弦波基频：10k/200=50hz

设置定时器中断

可以先设置占空比10%，在定时器中断中修改占空比为50%，查看波形，若对则成功打开定时器中断，同时可发现波形频率为10khz

同理设置TIM17产生互补pwm，通过芯片来控制q3 q4 ，查看波形。

将TIM16当作高频管，在每个TIM中断中更新其占空比。

每个定时器中断的频率为10khz，想要输出的正弦波为50hz，所以可以采样10k/50=200个点，生成一个200个点，幅值为arr的正弦表（*后续发现正弦表的幅值应该比arr小一些，因为如果拉满的话，有些低占空比表征不明显，会像毛刺，不能发波*）

![image-20240415141227610](C:\Users\syd12\AppData\Roaming\Typora\typora-user-images\image-20240415141227610.png)

在定时器中断中更新crr的值，需要注意的是正弦表产生的值有负的，crr不可能为负，需要设置为arr+正弦表值将其变为正值。根据单极性调制的mos管图，可以发现在正弦波正半周q3为正值，q4为负值，可以先通过gpiosetbit来直接输出两个高低电平的gpio来控制，或者使用TIM17，在正半周将占空比设为100%就是输出高电平导通了（*如果arr设置为799，crr要设置为800，不然会有1/800的占空比，小毛刺*）。

![img](https://img-blog.csdnimg.cn/05a9f08e9f2f4c4b84d5172d98378079.png)

代码如下：

![image-20240416191746046](C:\Users\syd12\AppData\Roaming\Typora\typora-user-images\image-20240416191746046.png)

观察产生的pwm，发现果然q1 q2 对应的pwm占空比在不断变化，q3 q4 对应的占空比为50%，一半时间为正，一板时间为负。

在产生pwm后需要通过驱动芯片才能接到igbt，通过辅电30v给芯片供电，然后测量mos管的电压。

发现经过驱动芯片后波形有所不同，需要注意的是要通过差分探头来测量q1 q2， 是否在同一时间都有高电平，若有则会导致短路。

![img](https://pic4.zhimg.com/80/v2-1ab723e257a5bad97cbcf1eac53948af_720w.webp)

q1 q2使用的是互补输出，通过设置定时器的死区时间来调节

![image-20240416175522718](C:\Users\syd12\AppData\Roaming\Typora\typora-user-images\image-20240416175522718.png)

![image-20240416175546523](C:\Users\syd12\AppData\Roaming\Typora\typora-user-images\image-20240416175546523.png)

*需要注意的是死区时间也不能设置过大，过大也会导致有重叠。*

死区时间也跟分频有关，如果太小可以修改分频时间。

当经过驱动芯片后导通到mos管的pwm与预期一样便可上bus电压测试输出。

![IMG_20240416_163237](D:\qq\1050351214\FileRecv\MobileFile\IMG_20240416_163237.jpg)

可以发现在过零点存在畸变。

![image-20240416184923980](C:\Users\syd12\AppData\Roaming\Typora\typora-user-images\image-20240416184923980.png)

有回答说增大自举电容试试。

通过尝试另一种方法，增加采样点跟arr幅值来解决。

之前使用了5+1来预分频使得定时器基频为48/（5+1）=8M，本次使预分频为0，arr的值为4000，正弦表幅值3000，采样点480，得到50hz的输出正弦波，发现效果好些。

![IMG_20240416_170634](D:\qq\1050351214\FileRecv\MobileFile\IMG_20240416_170634.jpg)



有了基本开环输出可以考虑闭环，通过ADC采集输出的电压，设置目标电压经过pid得到调整系数，再乘以基波占空比就可以实现电压闭环，因为输出正弦波就是基波plus。

matlab 单相全桥逆变电压闭环：

![image-20240416185913719](C:\Users\syd12\AppData\Roaming\Typora\typora-user-images\image-20240416185913719.png)

![image-20240416190243667](C:\Users\syd12\AppData\Roaming\Typora\typora-user-images\image-20240416190243667.png)

还可以实现频率闭环，可以通过ad采样来获得输出频率，经过pid来调整采样点数也可以实现频率闭环。





cite：

https://blog.csdn.net/lwb450921/article/details/128514857

https://zhuanlan.zhihu.com/p/256406416

https://ww2.mathworks.cn/matlabcentral/fileexchange/125335-single-phase-full-bridge-inverter-with-spwm



